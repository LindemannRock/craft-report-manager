{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('report-manager') %}
{% set title = isNew ? 'New Report'|t('report-manager') : 'Edit Report'|t('report-manager') %}
{% set fullPageForm = true %}
{% set selectedSubnavItem = 'reports' %}
{% set saveShortcutRedirect = cpUrl('report-manager/reports/{id}') %}
{% set retainScrollOnSaveShortcut = true %}

{% set crumbs = [
    { label: reportHelper.fullName, url: url('report-manager') },
    { label: 'Reports'|t('report-manager'), url: url('report-manager/reports') },
    { label: isNew ? 'New Report'|t('report-manager') : report.name }
] %}

{# Get current entity IDs for checkboxes #}
{% set selectedEntityIds = report.entityIdsArray ?? [] %}

{% block actionButton %}
    <div class="btngroup submit">
        <button type="submit" class="btn submit">{{ 'Save'|t('app') }}</button>
        <button type="button" class="btn submit menubtn"></button>
        <div class="menu">
            <ul role="listbox">
                <li>
                    <a class="formsubmit" role="option" tabindex="0" data-redirect="{{ cpUrl('report-manager/reports/{id}')|hash }}">
                        <span class="label">{{ 'Save and continue editing'|t('app') }}</span>
                        <span class="shortcut" id="save-shortcut"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% if not isNew and currentUser.can('reportManager:manageReports') %}
        <button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
        <div id="action-menu" class="menu menu--disclosure">
            <ul>
                <li>
                    <button class="menu-item error formsubmit" data-destructive data-action="report-manager/reports/delete" data-params='{"id":{{ report.id }}}' data-confirm="{{ 'Are you sure you want to delete this report?'|t('report-manager') }}" data-redirect="{{ 'report-manager/reports'|hash }}" data-headers='{"Accept":"application/json"}'>
                        <span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
                        <span class="menu-item-label">{{ 'Delete'|t('app') }}</span>
                    </button>
                </li>
            </ul>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <input type="hidden" name="action" value="report-manager/reports/save">
    <input type="hidden" name="redirect" value="{{ 'report-manager/reports'|hash }}">
    {% if not isNew %}
        <input type="hidden" name="reportId" value="{{ report.id }}">
    {% endif %}
    {{ csrfInput() }}

    <div id="fields">
        {{ forms.textField({
            first: true,
            label: 'Name'|t('report-manager'),
            instructions: 'A descriptive name for this report.'|t('report-manager'),
            id: 'name',
            name: 'name',
            value: report.name,
            required: true,
            errors: report.getErrors('name')
        }) }}

        {{ forms.textField({
            label: 'Handle'|t('report-manager'),
            instructions: 'A unique identifier for this report.'|t('report-manager'),
            id: 'handle',
            name: 'handle',
            class: 'code',
            value: report.handle,
            errors: report.getErrors('handle')
        }) }}

        {{ forms.textareaField({
            label: 'Description'|t('report-manager'),
            instructions: 'Optional description for this report.'|t('report-manager'),
            id: 'description',
            name: 'description',
            value: report.description,
            rows: 3,
            errors: report.getErrors('description')
        }) }}

        <hr>

        {{ forms.selectField({
            label: 'Data Source'|t('report-manager'),
            instructions: 'Select the data source for this report.'|t('report-manager'),
            id: 'dataSource',
            name: 'dataSource',
            value: report.dataSource ?? dataSourceOptions|first.value ?? '',
            options: dataSourceOptions,
            required: true,
            errors: report.getErrors('dataSource')
        }) }}

        {# Multi-select forms as checkboxes #}
        <div class="field{{ report.getErrors('entityIds') ? ' has-errors' : '' }}" id="forms-field">
            <div class="heading">
                <label class="required">{{ 'Forms to Export'|t('report-manager') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'Select one or more forms to include in this report.'|t('report-manager') }}</p>
            </div>
            <div class="input">
                <div id="forms-container">
                    {% if entities|length > 0 %}
                        {% for entity in entities %}
                            {{ forms.checkboxField({
                                label: entity.name ~ ' <span class="light">(' ~ entity.submissionCount ~ ' submissions)</span>',
                                name: 'entityIds[]',
                                value: entity.id,
                                checked: entity.id in selectedEntityIds
                            }) }}
                        {% endfor %}
                    {% else %}
                        <p class="light">{{ 'No forms available.'|t('report-manager') }}</p>
                    {% endif %}
                </div>
            </div>
            {% if report.getErrors('entityIds') %}
                <ul class="errors">
                    {% for error in report.getErrors('entityIds') %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

    </div>
{% endblock %}

{% block details %}
    <div class="meta">
        {{ forms.lightswitchField({
            label: 'Enabled'|t('report-manager'),
            id: 'enabled',
            name: 'enabled',
            on: report.enabled ?? true
        }) }}

        {% if siteOptions|length > 0 %}
            {{ forms.selectField({
                label: 'Site'|t('report-manager'),
                id: 'siteId',
                name: 'siteId',
                value: report.siteId ?? '',
                options: siteOptions
            }) }}
        {% endif %}

        {{ forms.selectField({
            label: 'Date Range'|t('report-manager'),
            id: 'dateRange',
            name: 'dateRange',
            value: report.dateRange,
            options: dateRangeOptions|merge([{ value: 'custom', label: 'Custom Range'|t('report-manager') }]),
            errors: report.getErrors('dateRange'),
            toggle: true,
            targetPrefix: 'daterange-'
        }) }}

        <div id="daterange-custom"{% if report.dateRange != 'custom' %} class="hidden"{% endif %}>
            {{ forms.dateField({
                label: 'Start Date'|t('report-manager'),
                id: 'customDateStart',
                name: 'customDateStart',
                value: report.customDateStart
            }) }}

            {{ forms.dateField({
                label: 'End Date'|t('report-manager'),
                id: 'customDateEnd',
                name: 'customDateEnd',
                value: report.customDateEnd
            }) }}
        </div>

        {{ forms.selectField({
            label: 'Format'|t('report-manager'),
            id: 'exportFormat',
            name: 'exportFormat',
            value: report.exportFormat,
            options: exportFormatOptions,
            errors: report.getErrors('exportFormat')
        }) }}

        {{ forms.selectField({
            label: 'Mode'|t('report-manager'),
            id: 'exportMode',
            name: 'exportMode',
            value: report.exportMode ?? 'separate',
            options: [
                { value: 'separate', label: 'Separate Files'|t('report-manager') },
                { value: 'combined', label: 'Combined File'|t('report-manager') }
            ],
            errors: report.getErrors('exportMode')
        }) }}

        {{ forms.lightswitchField({
            label: 'Scheduled'|t('report-manager'),
            id: 'enableSchedule',
            name: 'enableSchedule',
            on: report.enableSchedule ?? false,
            toggle: 'schedule-field'
        }) }}

        {{ forms.selectField({
            label: 'Frequency'|t('report-manager'),
            id: 'schedule',
            name: 'schedule',
            value: report.schedule,
            options: scheduleOptions|filter(o => o.value != 'disabled'),
            errors: report.getErrors('schedule'),
            fieldId: 'schedule-field',
            fieldClass: (report.enableSchedule ?? false) ? '' : 'hidden'
        }) }}

        {% if not isNew %}
            <div class="field" style="margin-top: 15px;">
                <div class="heading">
                    <label>{{ 'Actions'|t('report-manager') }}</label>
                </div>
                <div class="input">
                    <div class="btngroup">
                        <button type="button" class="btn menubtn" data-icon="settings">{{ 'Report Actions'|t('report-manager') }}</button>
                        <div class="menu">
                            <ul>
                                <li><a id="generate-now-btn" href="#">{{ 'Generate Now'|t('report-manager') }}</a></li>
                                <li><a href="{{ url('report-manager/reports/' ~ report.id ~ '/generated') }}">{{ 'View Generated'|t('report-manager') }}</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    {% if not isNew %}
        <dl class="meta read-only">
            <div class="data">
                <dt class="heading">{{ 'Status'|t('report-manager') }}</dt>
                <dd class="value">
                    <span class="status {{ report.enabled ? 'live' : 'disabled' }}"></span>
                    {{ report.enabled ? 'Enabled'|t('report-manager') : 'Disabled'|t('report-manager') }}
                </dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'ID'|t('app') }}</dt>
                <dd class="value">{{ report.id }}</dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'Forms'|t('report-manager') }}</dt>
                <dd class="value">{{ report.entityIdsArray|length }}</dd>
            </div>
            {% if report.lastGeneratedAt %}
                <div class="data">
                    <dt class="heading">{{ 'Last Generated'|t('report-manager') }}</dt>
                    <dd class="value">{{ report.lastGeneratedAt|lrDatetime }}</dd>
                </div>
            {% endif %}
            {% if report.enableSchedule and report.nextScheduledAt %}
                <div class="data">
                    <dt class="heading">{{ 'Next Scheduled'|t('report-manager') }}</dt>
                    <dd class="value">{{ report.nextScheduledAt|lrDatetime }}</dd>
                </div>
            {% endif %}
            <div class="data">
                <dt class="heading">{{ 'Created'|t('app') }}</dt>
                <dd class="value">{{ report.dateCreated|lrDatetime }}</dd>
            </div>
            <div class="data">
                <dt class="heading">{{ 'Updated'|t('app') }}</dt>
                <dd class="value">{{ report.dateUpdated|lrDatetime }}</dd>
            </div>
        </dl>
    {% endif %}
{% endblock %}

{% js %}
// Auto-generate handle from name
const nameField = document.getElementById('name');
const handleField = document.getElementById('handle');
let handleChanged = {{ (report.handle ?? '') ? 'true' : 'false' }};

handleField.addEventListener('input', function() {
    handleChanged = true;
});

nameField.addEventListener('input', function() {
    if (!handleChanged) {
        handleField.value = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
    }
});

// Set platform-specific keyboard shortcut
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
const saveShortcut = document.getElementById('save-shortcut');
if (saveShortcut) {
    saveShortcut.textContent = isMac ? 'âŒ˜S' : 'Ctrl+S';
}

// Toggle custom date range visibility
$('#dateRange').on('change', function() {
    if ($(this).val() === 'custom') {
        $('#daterange-custom').removeClass('hidden').slideDown();
    } else {
        $('#daterange-custom').slideUp();
    }
});


// Load forms when data source changes
$('#dataSource').on('change', function() {
    var dataSource = $(this).val();
    if (!dataSource) return;

    $.ajax({
        url: Craft.getCpUrl('report-manager/api/entities/' + dataSource),
        type: 'GET',
        dataType: 'json',
        success: function(response) {
            var $container = $('#forms-container');
            $container.empty();

            if (!response.success || response.entities.length === 0) {
                $container.html('<p class="light">{{ 'No forms available.'|t('report-manager') }}</p>');
                return;
            }

            response.entities.forEach(function(entity) {
                var $wrapper = $('<div class="field checkboxfield">');
                var $input = $('<div class="input ltr">');
                var $label = $('<label>');
                var $checkbox = $('<input type="checkbox" name="entityIds[]" value="' + entity.id + '">');

                $label.append($checkbox);
                $label.append(' ' + entity.name + ' <span class="light">(' + entity.submissionCount + ' submissions)</span>');
                $input.append($label);
                $wrapper.append($input);
                $container.append($wrapper);
            });
        }
    });
});

{% if not isNew %}
// Generate Now action - separate POST request
$('#generate-now-btn').on('click', function(e) {
    e.preventDefault();
    Craft.sendActionRequest('POST', 'report-manager/reports/generate', {
        data: { reportId: {{ report.id }} }
    }).then(function(response) {
        window.location.href = Craft.getCpUrl('report-manager/reports/{{ report.id }}/generated');
    }).catch(function(error) {
        Craft.cp.displayError('{{ 'Could not generate export.'|t('report-manager') }}');
    });
});
{% endif %}
{% endjs %}
