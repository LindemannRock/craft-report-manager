{#
 # Exports Index - Using cp-table layout
 #
 # Lists all exports with filtering, sorting, bulk actions and pagination.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   GET QUERY PARAMETERS
   ============================================================================ #}

{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set formatFilter = craft.app.request.getParam('format', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'dateCreated') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}

{# ============================================================================
   BUILD FILTER OPTIONS
   ============================================================================ #}

{% set statusOptions = [
    {value: 'all', label: 'All'|t('report-manager'), status: 'all'},
    {value: 'pending', label: 'Pending'|t('report-manager'), colorKey: 'pending'},
    {value: 'processing', label: 'Processing'|t('report-manager'), colorKey: 'processing'},
    {value: 'completed', label: 'Completed'|t('report-manager'), colorKey: 'completed'},
    {value: 'failed', label: 'Failed'|t('report-manager'), colorKey: 'failed'},
] %}

{% set formatOptions = [
    {value: 'all', label: 'All Formats'|t('report-manager')},
    {value: 'csv', label: 'CSV'},
    {value: 'json', label: 'JSON'},
    {value: 'xlsx', label: 'XLSX'},
] %}

{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set canCreate = currentUser.can('reportManager:createExports') %}
{% set canDownload = currentUser.can('reportManager:downloadExports') %}
{% set canDelete = currentUser.can('reportManager:deleteExports') %}
{% set showActionsColumn = canDownload or canDelete %}

{% set tableConfig = {
    plugin: {
        handle: 'report-manager',
        name: reportHelper.fullName,
    },
    page: {
        title: 'Exports'|t('report-manager'),
        subnav: 'exports',
        crumbs: [
            { label: reportHelper.fullName, url: url('report-manager') },
            { label: 'Exports'|t('report-manager') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: statusFilter == 'all' ? 'All'|t('report-manager') : statusFilter|capitalize,
            colorSet: 'exportStatus',
            options: statusOptions,
        },
        {
            type: 'dropdown',
            param: 'format',
            current: formatFilter,
            label: formatFilter == 'all' ? 'All Formats'|t('report-manager') : formatFilter|upper,
            options: formatOptions,
        },
    ],
    search: {
        placeholder: 'Search exports...'|t('report-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'entityName', label: 'Name'|t('report-manager'), sortable: true},
            {key: 'format', label: 'Format'|t('report-manager'), sortable: true},
            {key: 'status', label: 'Status'|t('report-manager'), sortable: true},
            {key: 'recordCount', label: 'Records'|t('report-manager'), sortable: true},
            {key: 'fileSize', label: 'Size'|t('report-manager'), sortable: true},
            {key: 'triggeredBy', label: 'Type'|t('report-manager'), sortable: true},
            {key: 'dateCreated', label: 'Created'|t('report-manager'), sortable: true},
        ],
        items: exports,
        emptyMessage: 'No exports found.'|t('report-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'export'|t('report-manager'), plural: 'exports'|t('report-manager')},
    },
    checkboxes: canDelete,
    newButton: canCreate ? {
        url: url('report-manager/exports/new'),
        label: 'Quick Export'|t('report-manager'),
        permission: 'reportManager:createExports',
    } : null,
} %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {# Name #}
    <td>
        {% set displayName = item.filename ?? ('Export #' ~ item.id) %}
        {% if item.isCompleted() and canDownload %}
            <a href="{{ url('report-manager/exports/download/' ~ item.id) }}">
                <strong>{{ displayName }}</strong>
            </a>
        {% else %}
            <strong>{{ displayName }}</strong>
        {% endif %}
    </td>

    {# Format #}
    <td>{{ item.format|upper }}</td>

    {# Status #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.statusLabel ~ (item.isProcessing() ? ' (' ~ item.progress ~ '%)' : ''),
            value: item.status,
            colorSet: 'exportStatus',
        } only %}
    </td>

    {# Records #}
    <td>{{ item.recordCount|number_format }}</td>

    {# Size #}
    <td>{{ item.formattedFileSize }}</td>

    {# Triggered By #}
    <td><span class="light">{{ item.triggerLabel }}</span></td>

    {# Created #}
    <td class="light">{{ item.dateCreated|lrCompactDatetime }}</td>
{% endblock %}


{# ============================================================================
   ROW ACTIONS
   ============================================================================ #}

{% block rowActions %}
    {% if showActionsColumn %}
        {% if item.isCombinedExport() %}
            {% set displayName = 'Combined Export'|t('report-manager') ~ ' (' ~ item.getEntityIdsArray()|length ~ ' forms)' %}
        {% else %}
            {% set displayName = item.entityName ?? 'Export #' ~ item.id %}
        {% endif %}
        <td class="thin" style="text-align: right;">
            <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('report-manager') }}"></button>
            <div class="menu">
                <ul>
                    <li>
                        <a href="{{ url('report-manager/exports/' ~ item.id) }}">
                            {{ 'View'|t('report-manager') }}
                        </a>
                    </li>
                    {% if item.isCompleted() and canDownload %}
                        <li>
                            <a href="{{ url('report-manager/exports/download/' ~ item.id) }}">
                                {{ 'Download'|t('report-manager') }}
                            </a>
                        </li>
                    {% endif %}
                    {% if canDelete %}
                        <li><hr class="padded"></li>
                        <li>
                            <a class="export-action error" data-action="delete" data-id="{{ item.id }}" data-name="{{ displayName }}">
                                {{ 'Delete'|t('report-manager') }}
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </td>
    {% endif %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS
   ============================================================================ #}

{% block bulkActions %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="bulk-delete-btn">
            <span id="delete-label">{{ 'Delete'|t('report-manager') }}</span>
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Update delete label with count
        document.addEventListener('lr:selectionChanged', function(e) {
            const deleteLabel = document.getElementById('delete-label');
            if (deleteLabel && e.detail.count > 0) {
                deleteLabel.textContent = `{{ 'Delete'|t('report-manager') }} (${e.detail.count})`;
            }
        });

        // Bulk delete
        document.getElementById('bulk-delete-btn')?.addEventListener('click', function() {
            const ids = window.lrTableSelection?.getSelectedIds() || [];
            if (!ids.length) return;
            if (!confirm(`Delete ${ids.length} ${ids.length > 1 ? 'exports' : 'export'}? This cannot be undone.`)) return;

            Craft.sendActionRequest('POST', 'report-manager/exports/bulk-delete', {
                data: { exportIds: ids }
            }).then(function(response) {
                if (response.data.success) {
                    Craft.cp.displayNotice(`Deleted ${response.data.deleted} exports`);
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('Failed to delete exports');
            });
        });

        // Individual export action menu clicks
        document.querySelectorAll('.export-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const exportId = this.dataset.id;
                const exportName = this.dataset.name;

                if (action === 'delete') {
                    if (confirm('Delete export "' + exportName + '"? This cannot be undone.')) {
                        Craft.sendActionRequest('POST', 'report-manager/exports/delete', {
                            data: { id: exportId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('Export deleted');
                                setTimeout(() => window.location.reload(), 1000);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('Failed to delete export');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
